name: 🔍 Inspección Pasiva de Gateway

on:
  workflow_dispatch:

jobs:
  analisis-superficie:
    name: Análisis Pasivo de Superficie de Borde
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Clonar repositorio
        uses: actions/checkout@v4

      - name: 📦 Instalar herramientas necesarias
        run: |
          sudo apt update
          sudo apt install -y jq curl unzip
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: 📄 Crear archivo de objetivos
        run: echo "juice-shop.herokuapp.com" > objetivos.txt

      - name: 🌐 Ejecutar httpx (detección pasiva)
        run: |
          httpx -l objetivos.txt -title -tech-detect -tls-grab -json -no-color -silent > salida_httpx.json
          cat salida_httpx.json > logs_gatewayinspector.txt

      - name: 🧠 Extraer tecnología y versión
        id: extraer
        run: |
          tecnologia=$(jq -r '.webserver // .cdn_name // .tls.issuer_cn // .tls.subject_cn // empty' salida_httpx.json | head -n 1)
          if [[ -z "$tecnologia" || "$tecnologia" == "null" ]]; then
            echo "❌ No se pudo detectar ninguna tecnología."
            tecnologia="Desconocida"
          fi
          version_limpia=$(echo "$tecnologia" | grep -oP '[A-Za-z0-9\.\-]+' | head -n 1)
          echo "💡 Tecnología detectada: $tecnologia"
          echo "version=$version_limpia" >> $GITHUB_OUTPUT
          echo "Tecnología usada para búsqueda de CVE: $tecnologia" >> logs_gatewayinspector.txt

      - name: 🛡️ Consultar CVEs en CIRCL
        run: |
          version="${{ steps.extraer.outputs.version }}"
          echo "🔍 Consultando CVEs en: https://cve.circl.lu/api/search/$version"
          curl -s "https://cve.circl.lu/api/search/$version" > cves.json || echo "[]"
          if jq -e '.[]' cves.json > /dev/null 2>&1; then
            echo "✅ CVEs encontrados para $version:"
            jq '.[] | {id, summary}' cves.json | tee -a logs_gatewayinspector.txt
          else
            echo "Sin CVEs encontrados." | tee -a logs_gatewayinspector.txt
          fi

      - name: 📋 Checklist Final de Tecnologías Detectadas
        run: |
          echo "### Checklist de Tecnologías Detectadas" >> logs_gatewayinspector.txt
          for tech in waf ingress gateway tls nginx kubernetes apache modsecurity cloudflare haproxy envoy; do
            if grep -i "$tech" salida_httpx.json; then
              echo "- $tech: ✅" | tee -a logs_gatewayinspector.txt
            else
              echo "- $tech: ❌" | tee -a logs_gatewayinspector.txt
            fi
          done

      - name: 📝 Resultado del Análisis
        run: |
          echo "📝 Resultado del Análisis:"
          cat logs_gatewayinspector.txt
