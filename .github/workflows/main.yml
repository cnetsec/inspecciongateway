name: InspeccionGateway

on:
  workflow_dispatch:
    inputs:
      objetivo:
        description: 'Dominio o IP a analizar (ej: juice-shop.herokuapp.com)'
        required: true
        type: string

jobs:
  escaneo:
    name: AnÃ¡lisis Pasivo de Superficie de Borde
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout del repositorio
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Instalar herramientas necesarias
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget jq golang
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: ğŸŒ Fingerprint con httpx
        run: |
          echo "${{ inputs.objetivo }}" > objetivos.txt
          httpx -l objetivos.txt -title -tech-detect -tls-grab -json -no-color -silent > salida_httpx.json
          cat salida_httpx.json > logs_gatewayinspector.txt

      - name: ğŸ§  Extraer tecnologÃ­a y versiÃ³n
        id: extraer
        run: |
          servidor=$(jq -r '.[0].server' salida_httpx.json)
          version_limpia=$(echo "$servidor" | grep -oP '[A-Za-z0-9\.-]+')
          echo "ğŸ’¡ TecnologÃ­a detectada: $servidor"
          echo "version=$version_limpia" >> $GITHUB_OUTPUT
          echo "$servidor" >> logs_gatewayinspector.txt

      - name: ğŸ›¡ï¸ Consultar posibles CVEs en CIRCL
        run: |
          version="${{ steps.extraer.outputs.version }}"
          cve_url="https://cve.circl.lu/api/search/$version"
          echo "ğŸ” Consultando CVEs en: $cve_url"
          curl -s "$cve_url" | jq '.data[] | {id, summary}' >> logs_gatewayinspector.txt || echo "Sin CVEs encontrados." >> logs_gatewayinspector.txt

      - name: âœ… Checklist de tecnologÃ­as detectadas
        run: |
          echo "### Checklist de TecnologÃ­as Detectadas" >> logs_gatewayinspector.txt
          for item in waf ingress gateway tls nginx kubernetes apache modsecurity cloudflare haproxy envoy; do
            if grep -i "$item" salida_httpx.json; then
              echo "- $item: âœ…" >> logs_gatewayinspector.txt
            else
              echo "- $item: âŒ" >> logs_gatewayinspector.txt
            fi
          done

      - name: ğŸ“¦ Mostrar resultado final
        run: |
          echo "ğŸ“ Resultado del AnÃ¡lisis:"
          cat logs_gatewayinspector.txt
