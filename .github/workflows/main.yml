name: 🔍 Inspección Pasiva de Gateway

on:
  workflow_dispatch:
    inputs:
      dominio:
        description: '🌐 Dominio a inspeccionar (ej: ejemplo.com)'
        required: true

jobs:
  inspeccion-pasiva:
    runs-on: ubuntu-latest
    name: 🌐 Inspección Pasiva
    steps:

      - name: ⬇️ Checkout del repositorio
        uses: actions/checkout@v4

      - name: ⚙️ Instalar dependencias necesarias
        run: |
          # Atualiza a lista de pacotes e instala as dependências básicas do sistema
          sudo apt-get update -y
          sudo apt-get install -y jq unzip curl whatweb # whatweb permanece, pois é independente

          # Instalação robusta do httpx
          # Baixa a URL do binário mais recente para Linux AMD64 usando a API do GitHub
          curl -s https://api.github.com/repos/projectdiscovery/httpx/releases/latest \
            | jq -r '.assets[] | select(.name | test("httpx_.*_linux_amd64.zip")) | .browser_download_url' \
            | xargs curl -L -o httpx.zip
          unzip httpx.zip
          chmod +x httpx
          sudo mv httpx /usr/local/bin/httpx
          rm httpx.zip # Limpa o arquivo ZIP baixado

          # REMOVIDO: Seções de instalação e limpeza do Wappalyzer-Go
          # As linhas relacionadas ao wappalyzergo foram removidas.

      - name: 🌐 Ejecutar herramientas pasivas
        run: |
          echo "🔎 Dominio: ${{ inputs.dominio }}"
          
          echo "🧪 HTTPX:"
          httpx -silent -title -tls-probe -status-code -tech-detect -ip -location -web-server -cdn -json -u ${{ inputs.dominio }} > httpx_output.json
          cat httpx_output.json

          echo "🧪 WhatWeb:"
          whatweb ${{ inputs.dominio }} > whatweb_output.txt
          cat whatweb_output.txt

          # REMOVIDO: Execução do Wappalyzer CLI
          # A chamada 'wappalyzergo' foi removida.

      - name: 📄 Analizar headers y certificado SSL
        run: |
          echo "🔐 Headers y Certificados:"
          curl -s -D - https://${{ inputs.dominio }} -o /dev/null > headers_output.txt
          cat headers_output.txt
          
          echo | openssl s_client -servername ${{ inputs.dominio }} -connect ${{ inputs.dominio }}:443 2>/dev/null | openssl x509 -noout -text > cert_output.txt
          cat cert_output.txt

      - name: 🧠 Consolidar tecnologías detectadas
        id: tecnologias # ID para referenciar este passo
        run: |
          # A partir de agora, a detecção de tecnologias dependerá APENAS do whatweb_output.txt
          # NOTA: whatweb é mais limitado que wappalyzer para lista de tecnologias.
          TECNOLOGIAS=$(cat whatweb_output.txt | grep -oP '\[[^\]]+\]' | sed 's/[\[\]]//g' | sort -u | paste -sd "," -)
          if [ -z "$TECNOLOGIAS" ]; then
            TECNOLOGIAS="No se detectaron tecnologías con WhatWeb."
          fi
          echo "🧩 Tecnologías encontradas: $TECNOLOGIAS"
          echo "tecnologias=$TECNOLOGIAS" >> $GITHUB_OUTPUT

      - name: 🐞 Buscar CVEs en CIRCL para tecnologías detectadas
        run: |
          echo "🔍 Buscando CVEs relacionados..."
          # Verifica se há alguma tecnologia para pesquisar antes de tentar o CIRCL API
          if [[ "${{ steps.tecnologias.outputs.tecnologias }}" == "No se detectaron tecnologías con WhatWeb." ]]; then
            echo "No se encontraron tecnologías específicas para buscar CVEs." > cve_resultados.txt
          else
            IFS=',' read -ra TECNOS <<< "${{ steps.tecnologias.outputs.tecnologias }}"
            > cve_resultados.txt # Limpa o arquivo de resultados CVE antes de começar

            for TEC in "${TECNOS[@]}"; do
              echo "🔎 $TEC" >> cve_resultados.txt
              curl -s -L -f "https://cve.circl.lu/api/search/$TEC" | jq '.[] | select(.id != null) | "\(.id): \(.summary)"' >> cve_resultados.txt
              echo "---" >> cve_resultados.txt
            done
          fi
          cat cve_resultados.txt

      - name: ✅ Checklist Final (Español)
        run: |
          echo "📋 Checklist Final:"
          echo "Dominio: ${{ inputs.dominio }}"
          echo "---"
          # Atualizado para refletir a dependência exclusiva de WhatWeb para tecnologias
          if [[ "${{ steps.tecnologias.outputs.tecnologias }}" == "No se detectaron tecnologías con WhatWeb." ]]; then
            echo "1. ¿Tecnología detectada? ❌ (Solo WhatWeb, puede ser limitado)"
          else
            echo "1. ¿Tecnología detectada? ✅ (Basado en WhatWeb)"
          fi
          
          echo "2. ¿Es un Gateway de seguridad (WAF, API Gateway, Ingress)?"
          if grep -i -E 'cloudflare|akamai|imperva|fastly|aws|api gateway|nginx ingress' whatweb_output.txt || grep -i -E 'x-forwarded|via|cf-ray|akamai|x-amz' headers_output.txt; then
            echo "➡️ Posible Gateway de seguridad detectado ✅"
          else
            echo "❌ No se detectó Gateway de seguridad"
          fi

          echo "3. ¿Pasa por Gateway (x-forwarded, headers específicos)?"
          if grep -i -E 'x-forwarded|via|x-amz' headers_output.txt; then
            echo "✅ Evidencia de paso por Gateway"
          else
            echo "❌ No hay evidencia clara de paso por Gateway"
          fi

          echo "4. ¿Certificado válido y vigente?"
          if grep -q "Not After" cert_output.txt; then
            echo "✅ Certificado analizado"
          else
            echo "⚠️ No se obtuvo certificado"
          fi

          echo "5. ¿CVEs encontrados?"
          # Ajustado para considerar o caso de nenhuma tecnologia detectada para CVEs
          if grep -q "CVE-" cve_resultados.txt && [[ "${{ steps.tecnologias.outputs.tecnologias }}" != "No se detectaron tecnologías con WhatWeb." ]]; then
            echo "⚠️ Hay CVEs asociados a las tecnologías detectadas"
          else
            echo "✅ No se encontraron CVEs relevantes o no se detectaron tecnologías para buscar."
          fi
