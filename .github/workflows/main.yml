name: InspeccionGateway

on:
  workflow_dispatch:
    inputs:
      objetivo:
        description: 'Dominio o IP a analizar (ej: juice-shop.herokuapp.com)'
        required: true
        type: string

jobs:
  escaneo:
    name: Análisis Pasivo de Superficie de Borde
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout del repositorio
        uses: actions/checkout@v4

      - name: 🛠️ Instalar herramientas necesarias
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget jq golang
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: 🌐 Fingerprint con httpx
        run: |
          echo "${{ inputs.objetivo }}" > objetivos.txt
          httpx -l objetivos.txt -title -tech-detect -tls-grab -json -no-color -silent > salida_httpx.json
          cat salida_httpx.json > logs_gatewayinspector.txt

      - name: 🧠 Extraer tecnología y versión
        id: extraer
        run: |
          servidor=$(jq -r '.[0].server' salida_httpx.json)
          version_limpia=$(echo "$servidor" | grep -oP '[A-Za-z0-9\.-]+')
          echo "💡 Tecnología detectada: $servidor"
          echo "version=$version_limpia" >> $GITHUB_OUTPUT
          echo "$servidor" >> logs_gatewayinspector.txt

      - name: 🛡️ Consultar posibles CVEs en CIRCL
        run: |
          version="${{ steps.extraer.outputs.version }}"
          cve_url="https://cve.circl.lu/api/search/$version"
          echo "🔍 Consultando CVEs en: $cve_url"
          curl -s "$cve_url" | jq '.data[] | {id, summary}' >> logs_gatewayinspector.txt || echo "Sin CVEs encontrados." >> logs_gatewayinspector.txt

      - name: ✅ Checklist de tecnologías detectadas
        run: |
          echo "### Checklist de Tecnologías Detectadas" >> logs_gatewayinspector.txt
          for item in waf ingress gateway tls nginx kubernetes apache modsecurity cloudflare haproxy envoy; do
            if grep -i "$item" salida_httpx.json; then
              echo "- $item: ✅" >> logs_gatewayinspector.txt
            else
              echo "- $item: ❌" >> logs_gatewayinspector.txt
            fi
          done

      - name: 📦 Mostrar resultado final
        run: |
          echo "📝 Resultado del Análisis:"
          cat logs_gatewayinspector.txt
