name: ğŸ” InspecciÃ³n Pasiva de Gateway

on:
  workflow_dispatch:

jobs:
  analisis-superficie:
    name: AnÃ¡lisis Pasivo de Superficie de Borde
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar repositorio
        uses: actions/checkout@v4

      - name: ğŸ“¦ Instalar herramientas necesarias
        run: |
          sudo apt update
          sudo apt install -y jq curl unzip
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: ğŸ“„ Crear archivo de objetivos
        run: echo "juice-shop.herokuapp.com" > objetivos.txt

      - name: ğŸŒ Ejecutar httpx (detecciÃ³n pasiva)
        run: |
          httpx -l objetivos.txt -title -tech-detect -tls-grab -json -no-color -silent > salida_httpx.json
          cat salida_httpx.json > logs_gatewayinspector.txt

      - name: ğŸ§  Extraer tecnologÃ­a y versiÃ³n
        id: extraer
        run: |
          tecnologia=$(jq -r '.webserver // .cdn_name // .tls.issuer_cn // .tls.subject_cn // empty' salida_httpx.json | head -n 1)
          if [[ -z "$tecnologia" || "$tecnologia" == "null" ]]; then
            echo "âŒ No se pudo detectar ninguna tecnologÃ­a."
            tecnologia="Desconocida"
          fi
          version_limpia=$(echo "$tecnologia" | grep -oP '[A-Za-z0-9\.\-]+' | head -n 1)
          echo "ğŸ’¡ TecnologÃ­a detectada: $tecnologia"
          echo "version=$version_limpia" >> $GITHUB_OUTPUT
          echo "TecnologÃ­a usada para bÃºsqueda de CVE: $tecnologia" >> logs_gatewayinspector.txt

      - name: ğŸ›¡ï¸ Consultar CVEs en CIRCL
        run: |
          version="${{ steps.extraer.outputs.version }}"
          echo "ğŸ” Consultando CVEs en: https://cve.circl.lu/api/search/$version"
          curl -s "https://cve.circl.lu/api/search/$version" > cves.json || echo "[]"
          if jq -e '.[]' cves.json > /dev/null 2>&1; then
            echo "âœ… CVEs encontrados para $version:"
            jq '.[] | {id, summary}' cves.json | tee -a logs_gatewayinspector.txt
          else
            echo "Sin CVEs encontrados." | tee -a logs_gatewayinspector.txt
          fi

      - name: ğŸ“‹ Checklist Final de TecnologÃ­as Detectadas
        run: |
          echo "### Checklist de TecnologÃ­as Detectadas" >> logs_gatewayinspector.txt
          for tech in waf ingress gateway tls nginx kubernetes apache modsecurity cloudflare haproxy envoy; do
            if grep -i "$tech" salida_httpx.json; then
              echo "- $tech: âœ…" | tee -a logs_gatewayinspector.txt
            else
              echo "- $tech: âŒ" | tee -a logs_gatewayinspector.txt
            fi
          done

      - name: ğŸ“ Resultado del AnÃ¡lisis
        run: |
          echo "ğŸ“ Resultado del AnÃ¡lisis:"
          cat logs_gatewayinspector.txt
