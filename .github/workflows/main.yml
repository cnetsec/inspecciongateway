name: ğŸ” InspecciÃ³n Pasiva de Gateway

on:
  workflow_dispatch:
    inputs:
      dominio:
        description: 'ğŸŒ Dominio a inspeccionar (ej: ejemplo.com)'
        required: true

jobs:
  inspeccion-pasiva:
    runs-on: ubuntu-latest
    name: ğŸŒ InspecciÃ³n Pasiva
    steps:

      - name: â¬‡ï¸ Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar dependencias necesarias
        run: |
          # Atualiza a lista de pacotes e instala as dependÃªncias bÃ¡sicas do sistema
          sudo apt-get update -y # Adicionado -y para confirmar automaticamente
          sudo apt-get install -y jq unzip curl whatweb

          # InstalaÃ§Ã£o robusta do httpx
          # Baixa a URL do binÃ¡rio mais recente para Linux AMD64 usando a API do GitHub
          curl -s https://api.github.com/repos/projectdiscovery/httpx/releases/latest \
            | jq -r '.assets[] | select(.name | test("httpx_.*_linux_amd64.zip")) | .browser_download_url' \
            | xargs curl -L -o httpx.zip # Baixa o arquivo ZIP
          unzip httpx.zip # Descompacta
          chmod +x httpx # Adiciona permissÃ£o de execuÃ§Ã£o
          sudo mv httpx /usr/local/bin/httpx # Move para um diretÃ³rio no PATH
          rm httpx.zip # Limpa o arquivo ZIP baixado

          # InstalaÃ§Ã£o robusta do Wappalyzer-Go
          # CORREÃ‡ÃƒO CRÃTICA: Ajustado o padrÃ£o regex no jq para 'wappalyzer_.*_linux_amd64.zip'
          # O binÃ¡rio Wappalyzer-Go Ã© frequentemente nomeado 'wappalyzer' em seus releases
          curl -s https://api.github.com/repos/projectdiscovery/wappalyzergo/releases/latest \
            | jq -r '.assets[] | select(.name | test("wappalyzer_.*_linux_amd64.zip")) | .browser_download_url' \
            | xargs curl -L -o wappalyzergo.zip # Baixa o arquivo ZIP
          unzip wappalyzergo.zip # Descompacta
          chmod +x wappalyzer # Adiciona permissÃ£o de execuÃ§Ã£o ao binÃ¡rio extraÃ­do (geralmente 'wappalyzer')
          sudo mv wappalyzer /usr/local/bin/wappalyzergo # Move e renomeia para 'wappalyzergo' para consistÃªncia
          rm wappalyzergo.zip # Limpa o arquivo ZIP baixado

      - name: ğŸŒ Ejecutar herramientas pasivas
        run: |
          echo "ğŸ” Dominio: ${{ inputs.dominio }}"
          
          echo "ğŸ§ª HTTPX:"
          # Executa httpx e salva a saÃ­da JSON
          httpx -silent -title -tls-probe -status-code -tech-detect -ip -location -web-server -cdn -json -u ${{ inputs.dominio }} > httpx_output.json
          cat httpx_output.json # Exibe no log do workflow

          echo "ğŸ§ª WhatWeb:"
          # Executa whatweb e salva a saÃ­da de texto
          whatweb ${{ inputs.dominio }} > whatweb_output.txt
          cat whatweb_output.txt # Exibe no log do workflow

          echo "ğŸ§ª Wappalyzer CLI:"
          # Executa wappalyzergo (o binÃ¡rio renomeado) e salva a saÃ­da JSON
          wappalyzergo -urls ${{ inputs.dominio }} > wappalyzer_output.json
          cat wappalyzer_output.json # Exibe no log do workflow

      - name: ğŸ“„ Analizar headers y certificado SSL
        run: |
          echo "ğŸ” Headers y Certificados:"
          # ObtÃ©m apenas os headers HTTP(S) do domÃ­nio
          curl -s -D - https://${{ inputs.dominio }} -o /dev/null > headers_output.txt
          cat headers_output.txt # Exibe no log do workflow
          
          # ObtÃ©m e exibe detalhes do certificado SSL/TLS
          echo | openssl s_client -servername ${{ inputs.dominio }} -connect ${{ inputs.dominio }}:443 2>/dev/null | openssl x509 -noout -text > cert_output.txt
          cat cert_output.txt # Exibe no log do workflow

      - name: ğŸ§  Consolidar tecnologÃ­as detectadas
        id: tecnologias # ID para referenciar este passo
        run: |
          # Extrai nomes de tecnologias do JSON do Wappalyzer, remove duplicatas e formata em string CSV
          TECNOLOGIAS=$(cat wappalyzer_output.json | jq -r '.[].technologies[].name' | sort -u | paste -sd "," -)
          echo "ğŸ§© TecnologÃ­as encontradas: $TECNOLOGIAS"
          # Define a string de tecnologias como uma saÃ­da do passo para uso posterior
          echo "tecnologias=$TECNOLOGIAS" >> $GITHUB_OUTPUT

      - name: ğŸ Buscar CVEs en CIRCL para tecnologÃ­as detectadas
        run: |
          echo "ğŸ” Buscando CVEs relacionados..."
          # Divide a string CSV de tecnologias em um array Bash
          IFS=',' read -ra TECNOS <<< "${{ steps.tecnologias.outputs.tecnologias }}"
          > cve_resultados.txt # Limpa o arquivo de resultados CVE antes de comeÃ§ar

          # Itera sobre cada tecnologia para buscar CVEs na API do CIRCL
          for TEC in "${TECNOS[@]}"; do
            echo "ğŸ” $TEC" >> cve_resultados.txt
            # Adicionado -L para seguir redirects e -f para falhar silenciosamente se a API der erro
            curl -s -L -f "https://cve.circl.lu/api/search/$TEC" | jq '.[] | select(.id != null) | "\(.id): \(.summary)"' >> cve_resultados.txt
            echo "---" >> cve_resultados.txt # Separador para facilitar a leitura
          done
          cat cve_resultados.txt # Exibe os resultados dos CVEs no log

      - name: âœ… Checklist Final (EspaÃ±ol)
        run: |
          echo "ğŸ“‹ Checklist Final:"
          echo "Dominio: ${{ inputs.dominio }}"
          echo "---"
          echo "1. Â¿TecnologÃ­a detectada? âœ…"
          
          echo "2. Â¿Es un Gateway de seguridad (WAF, API Gateway, Ingress)?"
          # Verifica se hÃ¡ menÃ§Ãµes a gateways conhecidos nos outputs de whatweb ou headers
          if grep -i -E 'cloudflare|akamai|imperva|fastly|aws|api gateway|nginx ingress' whatweb_output.txt || grep -i -E 'x-forwarded|via|cf-ray|akamai|x-amz' headers_output.txt; then
            echo "â¡ï¸ Posible Gateway de seguridad detectado âœ…"
          else
            echo "âŒ No se detectÃ³ Gateway de seguridad"
          fi

          echo "3. Â¿Pasa por Gateway (x-forwarded, headers especÃ­ficos)?"
          # Verifica headers comuns que indicam passagem por proxies/gateways
          if grep -i -E 'x-forwarded|via|x-amz' headers_output.txt; then
            echo "âœ… Evidencia de paso por Gateway"
          else
            echo "âŒ No hay evidencia clara de paso por Gateway"
          fi

          echo "4. Â¿Certificado vÃ¡lido y vigente?"
          # Verifica se o certificado foi analisado (presenÃ§a de "Not After")
          if grep -q "Not After" cert_output.txt; then
            echo "âœ… Certificado analizado"
          else
            echo "âš ï¸ No se obtuvo certificado"
          fi

          echo "5. Â¿CVEs encontrados?"
          # Verifica se foram encontrados CVEs no arquivo de resultados
          if grep -q "CVE-" cve_resultados.txt; then
            echo "âš ï¸ Hay CVEs asociados a las tecnologÃ­as detectadas"
          else
            echo "âœ… No se encontraron CVEs relevantes"
          fi
