name: ðŸ” InspecciÃ³n Pasiva de Gateway

on:
  workflow_dispatch:
    inputs:
      dominio:
        description: 'ðŸŒ Dominio objetivo'
        required: true
        type: string

jobs:
  inspeccion-pasiva:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš¥ Preparar entorno
        run: |
          sudo apt update
          sudo apt install -y whatweb jq curl unzip golang

      - name: ðŸ”§ Instalar httpx via Go
        run: |
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          sudo mv ~/go/bin/httpx /usr/local/bin/

      - name: ðŸ“ Criar arquivo de objetivos
        run: echo "${{ inputs.dominio }}" > objetivos.txt

      - name: ðŸŒ Executar httpx
        run: |
          httpx -l objetivos.txt -title -tech-detect -tls-grab -json -no-color -silent > salida_httpx.json || echo "[]" > salida_httpx.json

      - name: ðŸ•µï¸ Executar whatweb
        run: |
          whatweb "${{ inputs.dominio }}" > salida_whatweb.txt || echo "error" > salida_whatweb.txt

      - name: ðŸ’¡ Detectar tecnologÃ­a (fallback)
        id: tecnologia
        run: |
          tecnologia=$(jq -r '.[0].webserver // .[0].cdn_name // .[0].tls.issuer_cn // .[0].tls.subject_cn // empty' salida_httpx.json | head -n 1)
          if [ -z "$tecnologia" ]; then tecnologia="desconocida"; fi
          echo "ðŸ’¡ TecnologÃ­a detectada: $tecnologia"
          echo "tec=$tecnologia" >> "$GITHUB_OUTPUT"

      - name: ðŸ” Buscar CVEs na base CIRCL
        id: cves
        run: |
          tecnologia="${{ steps.tecnologia.outputs.tec }}"
          echo "ðŸ” Buscando CVEs para: $tecnologia"
          cve_result=$(curl -s "https://cve.circl.lu/api/search/$tecnologia" || echo "null")
          tem_cve="âŒ"
          if [[ "$cve_result" != "null" && "$cve_result" != "[]" && "$cve_result" != "{}" ]]; then
            tem_cve="âœ…"
          fi
          echo "has_cve=$tem_cve" >> "$GITHUB_OUTPUT"
          echo "$cve_result" > salida_cves.json

      - name: âœ… Checklist Final Inteligente
        run: |
          tecnologia="${{ steps.tecnologia.outputs.tec }}"
          tem_cve="${{ steps.cves.outputs.has_cve }}"
          passa_gateway="âŒ"
          tipo_gateway="âŒ"
          nao_passa_gateway="âŒ"
          tls="âŒ"

          if grep -q 'x-forwarded-for\|x-amz-apigateway' salida_whatweb.txt; then
            passa_gateway="âœ…"
          fi

          if echo "$tecnologia" | grep -iE 'gateway|ingress|nginx|haproxy|envoy|cloudflare|akamai|api|modsecurity|aws|forti|check|f5|paloalto'; then
            tipo_gateway="âœ…"
          fi

          if [[ "$passa_gateway" == "âŒ" && "$tipo_gateway" == "âŒ" ]]; then
            nao_passa_gateway="âœ…"
          fi

          if grep -q 'tls' salida_httpx.json; then
            tls="âœ…"
          fi

          echo "### ðŸ›¡ï¸ Checklist Final de Seguridad" > logs_gatewayinspector.txt
          echo "- ðŸŒ TecnologÃ­a detectada: $tecnologia" >> logs_gatewayinspector.txt
          echo "- ðŸ” Â¿Es un Gateway de Seguridad?: $tipo_gateway" >> logs_gatewayinspector.txt
          echo "- âž¡ï¸ Â¿Pasa por Gateway de Seguridad?: $passa_gateway" >> logs_gatewayinspector.txt
          echo "- ðŸ”“ Â¿No pasa por Gateway de Seguridad?: $nao_passa_gateway" >> logs_gatewayinspector.txt
          echo "- ðŸ“„ Â¿Tiene CVEs asociados?: $tem_cve" >> logs_gatewayinspector.txt
          echo "- ðŸ”’ Â¿Tiene TLS activo?: $tls" >> logs_gatewayinspector.txt
          cat logs_gatewayinspector.txt

      - name: ðŸ“¦ Salvar artefatos
        uses: actions/upload-artifact@v4
        with:
          name: resultados-inspecciongateway
          path: |
            salida_httpx.json
            salida_whatweb.txt
            salida_cves.json
            logs_gatewayinspector.txt
