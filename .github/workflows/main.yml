name: ğŸ” InspecciÃ³n Pasiva de Gateway

on:
  workflow_dispatch:
    inputs:
      dominio:
        description: 'ğŸŒ Dominio o IP objetivo'
        required: true
        default: ''
      user_agent:
        description: 'ğŸ§  User-Agent personalizado (opcional)'
        required: false
        default: 'Mozilla/5.0 (compatible; InspeccionGatewayBot/1.0)'

jobs:
  inspeccion-pasiva:
    runs-on: ubuntu-latest
    steps:

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Instalar dependencias
        run: |
          sudo apt update -y
          sudo apt install -y jq unzip curl whatweb
          wget -q https://github.com/projectdiscovery/httpx/releases/latest/download/httpx_amd64.tar.gz
          tar -xvzf httpx_amd64.tar.gz
          sudo mv httpx /usr/local/bin/httpx
          npm install -g wappalyzer

      - name: ğŸ“Œ Preparar objetivo
        run: echo "${{ inputs.dominio }}" > objetivos.txt

      - name: ğŸ” Executar httpx
        run: |
          httpx -l objetivos.txt -title -tech-detect -tls-grab -json -no-color -silent > salida_httpx.json || echo "[]" > salida_httpx.json

      - name: ğŸ” Executar whatweb
        run: |
          whatweb "${{ inputs.dominio }}" > salida_whatweb.txt || echo "error" > salida_whatweb.txt

      - name: ğŸŒ Executar Wappalyzer
        run: |
          wappalyzer "${{ inputs.dominio }}" > salida_wappalyzer.json || echo "{}" > salida_wappalyzer.json

      - name: ğŸ¤– Detectar tecnologia
        id: tecnologia
        run: |
          tecnologia=$(jq -r '.[0].webserver // .[0].cdn_name // .[0].tls.issuer_cn // .[0].tls.subject_cn // empty' salida_httpx.json | head -n 1)
          if [[ -z "$tecnologia" ]]; then
            tecnologia=$(cat salida_whatweb.txt | head -n 1 | cut -d',' -f1 | awk '{print $1}')
          fi
          if [[ -z "$tecnologia" ]]; then
            tecnologia=$(jq -r '.technologies[0].name // empty' salida_wappalyzer.json)
          fi
          tecnologia=${tecnologia:-desconocida}
          echo "ğŸ’¡ TecnologÃ­a detectada: $tecnologia"
          echo "tecnologia=$tecnologia" >> "$GITHUB_OUTPUT"

      - name: ğŸ“„ Buscar CVEs con CIRCL
        id: cves
        run: |
          tecnologia="${{ steps.tecnologia.outputs.tecnologia }}"
          echo "ğŸ” Buscando CVEs para: $tecnologia"
          cve_result=$(curl -s "https://cve.circl.lu/api/search/$tecnologia" || echo "null")
          tem_cve="âŒ"
          if [[ "$cve_result" != "null" && "$cve_result" != "[]" && "$cve_result" != "{}" ]]; then
            tem_cve="âœ…"
          fi
          echo "$cve_result" > salida_cves.json
          echo "has_cve=$tem_cve" >> "$GITHUB_OUTPUT"

      - name: âœ… Checklist de Seguridad
        run: |
          tecnologia="${{ steps.tecnologia.outputs.tecnologia }}"
          has_cve="${{ steps.cves.outputs.has_cve }}"
          tls_ativo=$(jq '.[0].tls | select(.subject_cn != null)' salida_httpx.json)
          if [[ -n "$tls_ativo" ]]; then tls="âœ…"; else tls="âŒ"; fi

          # HeurÃ­stica simples
          if echo "$tecnologia" | grep -iqE 'gateway|akamai|imperva|cloudflare|forti|barracuda|f5|proxy|cdn'; then
            is_gateway="âœ…"
            passes_gateway="âœ…"
            no_gateway="âŒ"
          elif grep -iq 'X-Forwarded-For' salida_httpx.json || grep -iq 'Via:' salida_httpx.json; then
            is_gateway="âŒ"
            passes_gateway="âœ…"
            no_gateway="âŒ"
          else
            is_gateway="âŒ"
            passes_gateway="âŒ"
            no_gateway="âœ…"
          fi

          echo "### ğŸ›¡ï¸ Checklist Final de Seguridad"
          echo "- ğŸŒ TecnologÃ­a detectada: $tecnologia"
          echo "- ğŸ” Â¿Es un Gateway de Seguridad?: $is_gateway"
          echo "- â¡ï¸ Â¿Pasa por Gateway de Seguridad?: $passes_gateway"
          echo "- ğŸ”“ Â¿No pasa por Gateway de Seguridad?: $no_gateway"
          echo "- ğŸ“„ Â¿Tiene CVEs asociados?: $has_cve"
          echo "- ğŸ”’ Â¿Tiene TLS activo?: $tls"

      - name: ğŸ“¦ Subir resultados
        uses: actions/upload-artifact@v4
        with:
          name: resultados-inspecciongateway
          path: |
            salida_httpx.json
            salida_whatweb.txt
            salida_wappalyzer.json
            salida_cves.json
