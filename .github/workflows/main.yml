name: 🔍 Inspección Gateway

on:
  workflow_dispatch:
    inputs:
      dominio:
        description: "🌐 Dominio o IP objetivo"
        required: true
        default: ""

jobs:
  inspeccion-pasiva:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Clonar repositorio
        uses: actions/checkout@v4

      - name: 🧰 Instalar dependencias
        run: |
          sudo apt update -y
          sudo apt install -y jq unzip curl whatweb
          wget https://github.com/projectdiscovery/httpx/releases/download/v1.6.5/httpx_1.6.5_linux_amd64.tar.gz
          tar -xzf httpx_1.6.5_linux_amd64.tar.gz
          chmod +x httpx
          sudo mv httpx /usr/local/bin/httpx

      - name: 🌐 Ejecutar httpx para obtener headers y fingerprint
        run: |
          echo "${{ github.event.inputs.dominio }}" > targets.txt
          httpx -silent -title -tech-detect -status-code -ip -json -no-color -o httpx_output.json -list targets.txt

      - name: 🔍 Ejecutar whatweb
        run: |
          whatweb -v ${{ github.event.inputs.dominio }} > whatweb_output.txt || echo "WhatWeb falló"

      - name: 🧠 Enriquecer con Wappalyzer (alternativa por headers)
        run: |
          curl -sL -D - ${{ github.event.inputs.dominio }} -o /dev/null > headers.txt
          grep -iE 'server:|x-powered-by:|via:|x-forwarded-for|cdn|akamai|cloudflare|forti|aws|waf' headers.txt > enriched_headers.txt || true

      - name: 🧬 Buscar posibles CVEs via CIRCL (basado en tecnologías encontradas)
        run: |
          TECNOLOGIAS=$(jq -r '.[].technologies[]?.name' httpx_output.json | sort -u)
          > cve_results.txt
          for tech in $TECNOLOGIAS; do
            echo "🔍 Buscando CVEs para: $tech" >> cve_results.txt
            curl -s "https://cve.circl.lu/api/search/$tech" | jq -r '.data[]?.id' | sort -u >> cve_results.txt || echo "❌ No se encontraron CVEs para $tech" >> cve_results.txt
          done

      - name: 📋 Generar checklist de hallazgos
        run: |
          echo "✅ Checklist de Inspección Pasiva" > checklist.md
          echo "- Dominio analizado: ${{ github.event.inputs.dominio }}" >> checklist.md
          echo "" >> checklist.md

          if grep -q -i 'waf\|forti\|cloudflare\|akamai\|aws' enriched_headers.txt; then
            echo "- ✅ Pasa por un Gateway de Seguridad (WAF/API Gateway/etc)" >> checklist.md
          else
            echo "- ⚠️ No se detectó un Gateway de Seguridad" >> checklist.md
          fi

          if grep -q -i 'nginx' enriched_headers.txt; then
            echo "- ✅ Se detectó NGINX (posible Ingress Controller)" >> checklist.md
          fi

          if [ -s cve_results.txt ]; then
            echo "- ⚠️ CVEs relacionados encontrados:" >> checklist.md
            cat cve_results.txt >> checklist.md
          else
            echo "- ✅ No se encontraron CVEs conocidos en tecnologías detectadas" >> checklist.md
          fi

          echo "" >> checklist.md
          echo "🧠 Tecnologías identificadas:" >> checklist.md
          jq -r '.[].technologies[]?.name' httpx_output.json | sort -u >> checklist.md

          echo "" >> checklist.md
          echo "🔚 Inspección completada con éxito." >> checklist.md

      - name: 📤 Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: resultados-inspeccion
          path: |
            httpx_output.json
            whatweb_output.txt
            enriched_headers.txt
            cve_results.txt
            checklist.md
