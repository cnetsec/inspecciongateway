name: ðŸ” InspecciÃ³n Pasiva de Gateway

on:
  workflow_dispatch:
    inputs:
      dominio:
        description: "ðŸŒ Dominio o IP objetivo"
        required: true

jobs:
  inspeccion-pasiva:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Clonar repositorio
        uses: actions/checkout@v4

      - name: ðŸ§° Instalar dependencias necesarias
        run: |
          sudo apt update -y
          sudo apt install -y jq unzip curl whatweb

          # Fallback seguro para httpx (Ãºltima versÃ£o vÃ¡lida conhecida)
          curl -LO https://github.com/projectdiscovery/httpx/releases/latest/download/httpx_amd64.tar.gz
          tar -xzf httpx_amd64.tar.gz
          chmod +x httpx
          sudo mv httpx /usr/local/bin/httpx

      - name: ðŸŒ Ejecutar httpx
        run: |
          echo "${{ github.event.inputs.dominio }}" > targets.txt
          httpx -silent -json -title -tech-detect -status-code -ip -o httpx_output.json -list targets.txt

      - name: ðŸ” Ejecutar WhatWeb
        run: |
          whatweb -v ${{ github.event.inputs.dominio }} > whatweb_output.txt || echo "WhatWeb fallÃ³"

      - name: ðŸ“¡ Obtener headers enriquecidos
        run: |
          curl -s -D - ${{ github.event.inputs.dominio }} -o /dev/null > headers.txt
          grep -iE 'server:|x-powered-by:|via:|x-forwarded-for|cdn|akamai|cloudflare|forti|aws|waf|nginx' headers.txt > enriched_headers.txt || true

      - name: ðŸ§¬ Buscar CVEs relacionados (CIRCL)
        run: |
          TECNOLOGIAS=$(jq -r '.[].technologies[]?.name' httpx_output.json | sort -u)
          > cve_results.txt
          for tech in $TECNOLOGIAS; do
            echo "ðŸ” Buscando CVEs para: $tech" >> cve_results.txt
            curl -s "https://cve.circl.lu/api/search/$tech" | jq -r '.data[]?.id' >> cve_results.txt || echo "âŒ No se encontraron CVEs para $tech" >> cve_results.txt
          done

      - name: ðŸ“‹ Generar checklist final
        run: |
          echo "## âœ… Informe de InspecciÃ³n Pasiva de Gateway" > checklist.md
          echo "- ðŸ” Dominio analizado: ${{ github.event.inputs.dominio }}" >> checklist.md
          echo "" >> checklist.md

          echo "### ðŸ§  TecnologÃ­as Detectadas:" >> checklist.md
          jq -r '.[].technologies[]?.name' httpx_output.json | sort -u >> checklist.md
          echo "" >> checklist.md

          if grep -qi 'waf\|forti\|cloudflare\|akamai\|aws\|proxy' enriched_headers.txt; then
            echo "- âœ… Pasa por Gateway de Seguridad (WAF/API Gateway)" >> checklist.md
          else
            echo "- âš ï¸ No pasa por Gateway de Seguridad" >> checklist.md
          fi

          if grep -qi 'nginx' enriched_headers.txt; then
            echo "- âœ… Posible Ingress Controller (NGINX)" >> checklist.md
          fi

          echo "" >> checklist.md
          if [ -s cve_results.txt ]; then
            echo "### ðŸ›¡ï¸ CVEs Relacionados Encontrados:" >> checklist.md
            sort -u cve_results.txt >> checklist.md
          else
            echo "- âœ… No se encontraron CVEs conocidos en las tecnologÃ­as detectadas" >> checklist.md
          fi

          echo "" >> checklist.md
          echo "### âœ… ClasificaciÃ³n General:" >> checklist.md
          echo "- TecnologÃ­a detectada âœ…" >> checklist.md
          grep -qi 'waf\|gateway' enriched_headers.txt && echo "- Es Gateway de Seguridad âœ…" >> checklist.md || echo "- No es Gateway de Seguridad âŒ" >> checklist.md
          grep -qi 'x-forwarded-for' enriched_headers.txt && echo "- Pasa por Gateway de Seguridad âœ…" >> checklist.md || echo "- No pasa por Gateway de Seguridad âŒ" >> checklist.md
          grep -qi 'nginx' enriched_headers.txt && echo "- Es un Ingress NGINX âœ…" >> checklist.md

          echo "" >> checklist.md
          echo "ðŸ§¾ AnÃ¡lisis completado." >> checklist.md

      - name: ðŸ“¤ Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: resultados-inspeccion
          path: |
            httpx_output.json
            whatweb_output.txt
            headers.txt
            enriched_headers.txt
            cve_results.txt
            checklist.md
